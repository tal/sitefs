#!/usr/bin/env ruby

require "bundler/setup"
require 'yaml'
require "sitefs"
require 'slop'

include Sitefs

opts = Slop.parse do |o|
  o.integer '-p', '--port', 'custom port', default: 8050
  o.bool '-o', '--only-once', "only generate the files once, don't watch"

  o.bool '-q', '--quiet', 'suppress output (quiet mode)'
  o.string '--config', 'location of config file (default .sitefsconfg.yml)', default: '.sitefsconfig.yml'

  o.on '--version', 'print the version' do
    puts VERSION
    exit
  end
end

unless File.exist?(opts[:config])
  abort "No config file found at #{opts[:config]}"
end

config = CommandConfig.from_file(opts[:config])

unless config
  abort "Invalid config file found at #{opts[:config]}"
end

if opts.help?
  puts opts
  exit
end

unless root_path = opts.args.first || config.root_path
  puts opts
  exit
end

config.root_path = root_path

watcher = Watcher.new config

if opts.only_once?
  watcher.generate
  exit
end

watcher.start port: opts[:port]
